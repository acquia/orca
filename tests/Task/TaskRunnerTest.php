<?php

namespace Acquia\Orca\Tests\Task;

use Acquia\Orca\Enum\StatusCode;
use Acquia\Orca\Task\StaticAnalysisTool\PhpLintTask;
use Acquia\Orca\Task\TaskInterface;
use Acquia\Orca\Task\TaskRunner;
use PHPUnit\Framework\TestCase;
use Symfony\Component\Console\Style\SymfonyStyle;

/**
 * @property \Prophecy\Prophecy\ObjectProphecy|\Acquia\Orca\Task\StaticAnalysisTool\ComposerValidateTask $composerValidateTask
 * @property \Prophecy\Prophecy\ObjectProphecy|\Acquia\Orca\Task\StaticAnalysisTool\PhpLintTask $phpLintTask
 */
class TaskRunnerTest extends TestCase {

  private const PATH = 'var/www/example';

  private const STATUS_MESSAGE = 'Printing status message';

  public function testTaskRunner() {
    $output = $this->prophesize(SymfonyStyle::class);
    $output->section(self::STATUS_MESSAGE)
      ->shouldBeCalledTimes(1);
    $output->success('Passed')
      ->shouldBeCalledTimes(2);
    /** @var \Symfony\Component\Console\Style\SymfonyStyle $output */
    $output = $output->reveal();
    /** @var \Acquia\Orca\Task\StaticAnalysisTool\PhpLintTask $php_lint */
    $php_lint = $this->setTaskExpectations(PhpLintTask::class);

    $runner = new TaskRunner($output);
    $runner->setPath('foobar')
      ->addTask($php_lint)
      ->setPath(self::PATH);
    $status_code = $runner->run();
    // Make sure tasks are reset on clone.
    (clone($runner))->run();

    $this->assertInstanceOf(TaskRunner::class, $runner, 'Instantiated class.');
    $this->assertEquals(StatusCode::OK, $status_code, 'Returned a "success" status code.');
  }

  protected function setTaskExpectations($class): TaskInterface {
    $task = $this->prophesize($class);
    $task->statusMessage()
      ->shouldBeCalledTimes(1)
      ->willReturn(self::STATUS_MESSAGE);
    $task->setPath(self::PATH)
      ->shouldBeCalledTimes(1)
      ->willReturn($task);
    $task->execute()->shouldBeCalledTimes(1);
    /** @var \Acquia\Orca\Task\TaskInterface $task */
    $task = $task->reveal();
    return $task;
  }

}
